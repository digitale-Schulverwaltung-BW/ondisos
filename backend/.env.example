# ============================================================================
# Backend Environment Configuration (Optional Overrides)
# ============================================================================
# This file contains OPTIONAL backend-specific settings.
#
# IMPORTANT: Core credentials (DB_USER, DB_PASS, etc.) are now in the ROOT .env
#            (one level up, next to docker-compose.yml) to avoid duplication.
#
# This file is for:
# - Backend-specific overrides (rate limiting, virus scan, auth, etc.)
# - Settings not needed by other containers
#
# For Docker deployments, most settings come from:
# 1. Root .env (DB credentials, secrets)
# 2. docker-compose.yml / docker-compose.prod.yml (environment overrides)
# 3. This file (optional backend-specific settings)
#
# Quick Setup:
#   cp .env.example .env
#   nano .env  # Add any overrides you need
#   chmod 600 .env  # Secure permissions
# ============================================================================

# ============================================================================
# APPLICATION
# ============================================================================
# Environment: production, development, testing
APP_ENV=production

# Debug Mode: false for production! (exposes sensitive data)
APP_DEBUG=false

# Force HTTPS (Production)
# Fallback if .htaccess HTTPS redirect is not configured
# Recommended: Use .htaccess redirect (more performant) + this as backup
# Set to true if behind HTTPS reverse proxy
FORCE_HTTPS=false

# ============================================================================
# DATABASE (Now in ROOT .env - no need to set here!)
# ============================================================================
# DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASS are in the root .env file.
# Only override here if you need different values for some reason.

# ============================================================================
# SECURITY & SECRETS (Core secrets in ROOT .env)
# ============================================================================
# PDF_TOKEN_SECRET and API_SECRET_KEY are in the root .env file.
# Only override here if you need different values.

# ============================================================================
# BACKEND-SPECIFIC SETTINGS (Safe to configure here)
# ============================================================================

# ============================================================================
# CORS SETTINGS
# ============================================================================
# Allowed Origins for CORS (comma-separated list of frontend URLs)
# The backend API (submit.php, upload.php) validates the Origin header
# against this whitelist to prevent unauthorized cross-origin requests.
#
# Examples:
#   Single domain: https://anmeldung.example.com
#   Multiple domains: https://anmeldung.example.com,https://forms.example.com
#   Development: http://localhost,http://localhost:8081
#
# IMPORTANT: Only add trusted frontend URLs! This prevents unauthorized
# websites from submitting forms to your backend.
#
ALLOWED_ORIGINS=http://localhost

# ============================================================================
# ADMIN AUTHENTICATION
# ============================================================================
# Enable login requirement for admin interface
# Recommended: true for public networks, false for secured intranet
AUTH_ENABLED=false

# Admin Username
ADMIN_USERNAME=admin

# Admin Password Hash
# Generate with: docker-compose exec backend php scripts/generate-password-hash.php "your-password"
# Or: php -r "echo password_hash('your-password', PASSWORD_DEFAULT);"
ADMIN_PASSWORD_HASH=

# ============================================================================
# SESSION
# ============================================================================
# Session lifetime in seconds (3600 = 1 hour)
SESSION_LIFETIME=3600

# Secure cookies (HTTPS only) - set to true in production with HTTPS!
SESSION_SECURE=true

# ============================================================================
# FILE UPLOAD
# ============================================================================
# Max upload size in bytes (10485760 = 10MB)
UPLOAD_MAX_SIZE=10485760

# Allowed file types (comma-separated)
UPLOAD_ALLOWED_TYPES=pdf,jpg,jpeg,png,gif,doc,docx

# ============================================================================
# RATE LIMITING
# ============================================================================
# Protects API endpoints from abuse and DoS attacks
RATE_LIMIT_ENABLED=true

# Max requests per window
RATE_LIMIT_MAX=10

# Time window in seconds (60 = 1 minute)
RATE_LIMIT_WINDOW=60

# ============================================================================
# VIRUS SCANNING (ClamAV)
# ============================================================================
# Scans uploaded files for malware using ClamAV (clamd TCP protocol).
# Requires the clamav service in docker-compose.yml.
#
# First startup downloads virus databases (~300MB, 60-90 seconds).
# Signatures are updated automatically by freshclam every 2 hours.
#
# VIRUS_SCAN_STRICT=false  → allow upload if ClamAV is unreachable (+ log warning)
# VIRUS_SCAN_STRICT=true   → reject upload if ClamAV is unreachable (safer)
VIRUS_SCAN_ENABLED=false
CLAMAV_HOST=clamav
CLAMAV_PORT=3310
VIRUS_SCAN_STRICT=false

# ============================================================================
# NOMINATIM (OpenStreetMap Geocoding)
# ============================================================================
# Automatische Ermittlung des Ortsteils beim Excel-Export.
# Formulare mit dem Hidden-Field "Teilort: autofill" werden beim Export via
# OpenStreetMap Nominatim aufgelöst.
#
# Nominatim ToS: Kontakt-Email oder URL MUSS angegeben werden (User-Agent).
# Leer lassen → Feature deaktiviert, kein API-Aufruf, Spalte bleibt leer.
#
# Beispiel:
#   NOMINATIM_CONTACT=schulverwaltung@ihre-schule.de
#   NOMINATIM_CONTACT=https://www.ihre-schule.de
NOMINATIM_CONTACT=

# ============================================================================
# PDF LOGO
# ============================================================================
# Logo path on this server, injected into generated PDFs.
# The frontend cannot know backend file paths, so this is configured here.
#
# Logos gehören in: backend/templates/pdf/assets/
# (Alle Dateien dort außer dem Beispiel-Logo sind in .gitignore)
#
# Filepath mapping:
# Docker-Pfad:  /var/www/html/templates/pdf/assets/dein-logo.png
# Host:               backend/templates/pdf/assets/dein-logo.png
#
# Beispiel-Logo (nur als Vorlage, nicht für Production!):
#   /var/www/html/templates/pdf/assets/logo.png
#
# Formular-spezifisch (hat Vorrang vor PDF_LOGO_PATH):
#   PDF_LOGO_BS=/var/www/html/templates/pdf/assets/logo-bs.png
#   PDF_LOGO_BK=/var/www/html/templates/pdf/assets/logo-bk.png
#
# Fallback für alle Formulare:
# PDF_LOGO_PATH=/var/www/html/templates/pdf/assets/logo.png

# ============================================================================
# AUTO-EXPUNGE
# ============================================================================
# Auto-delete archived entries after X days (0 = disabled)
# Recommended: 90-180 days for GDPR compliance
AUTO_EXPUNGE_DAYS=90

# Automatically mark entries as "exportiert" when exported to Excel
AUTO_MARK_AS_READ=true

# ============================================================================
# AUDIT LOG RETENTION
# ============================================================================
# Audit log (logs/audit.log) is rotated automatically every 6 hours.
# Entries older than AUDIT_LOG_RETENTION_DAYS are deleted.
# 0 = disabled (log grows indefinitely — not recommended for production)
#
# DSGVO note: The audit log contains personal data (usernames, IPs).
# 30–90 days is a common retention period aligned with BSI IT-Grundschutz.
AUDIT_LOG_RETENTION_DAYS=90

# ============================================================================
# LOGGING
# ============================================================================
# Log level: debug, info, warning, error
# Recommended: error for production, debug for development
LOG_LEVEL=error

# Log file path
LOG_FILE=/var/log/anmeldung/app.log

# ============================================================================
# PRODUCTION CHECKLIST
# ============================================================================
# Before deploying to production, ensure:
# [ ] APP_DEBUG=false
# [ ] APP_ENV=production
# [ ] PDF_TOKEN_SECRET is set (min 32 chars)
# [ ] DB_PASS is set and strong
# [ ] MYSQL_ROOT_PASSWORD is changed (if using Docker)
# [ ] MYSQL_PASSWORD is changed (if using Docker)
# [ ] AUTH_ENABLED=true (if public network)
# [ ] ADMIN_PASSWORD_HASH is set (if AUTH_ENABLED=true)
# [ ] SESSION_SECURE=true (if HTTPS enabled)
# [ ] FORCE_HTTPS=true (if behind HTTPS proxy)
# [ ] VIRUS_SCAN_ENABLED=true (if clamav service is running)
# [ ] .env file has chmod 600 permissions
# [ ] .env is in .gitignore (never commit!)
# ============================================================================