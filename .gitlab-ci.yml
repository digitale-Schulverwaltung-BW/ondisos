# ============================================================================
# GitLab CI/CD Pipeline for Ondisos School Registration System
# ============================================================================
# Stages: install → test → coverage → security → build → deploy-staging → deploy-production
# ============================================================================

# Default Docker image (PHP 8.2 with extensions)
image: php:8.2-cli

# Pipeline stages
stages:
  - install
  - test
  - coverage
  - security
  - build
  - deploy-staging
  - deploy-production

# Cache vendor directory for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - backend/vendor/

# Variables
variables:
  # Composer config
  COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer-cache"
  COMPOSER_ALLOW_SUPERUSER: "1"

  # Test environment variables (override production values)
  APP_ENV: "testing"
  DB_HOST: "localhost"
  DB_NAME: "anmeldung_test"
  DB_USER: "test"
  DB_PASS: "test"
  PDF_TOKEN_SECRET: "test-secret-key-for-ci-pipeline-min-32-chars-long"
  FORCE_HTTPS: "false"
  AUTH_ENABLED: "false"
  RATE_LIMIT_ENABLED: "false"

# Before script - install dependencies
before_script:
  - cd backend

  # Install system dependencies (including libraries for GD)
  - apt-get update -qq
  - apt-get install -y -qq git unzip libpng-dev libjpeg-dev libfreetype6-dev

  # Configure and install PHP extensions required for project
  - docker-php-ext-configure gd --with-freetype --with-jpeg
  - docker-php-ext-install pdo pdo_mysql gd

  # Install Composer
  - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

  # Verify Composer installation
  - composer --version

# Job: Install Dependencies
install_dependencies:
  stage: install
  script:
    - composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - backend/vendor/
    policy: push
  artifacts:
    paths:
      - backend/vendor/
    expire_in: 1 hour

test_unit:
  stage: test
  dependencies:
    - install_dependencies
  before_script:
    - pecl install pcov
    - docker-php-ext-enable pcov
    - export PATH="$PATH:/usr/local/bin"  # Composer wieder in PATH
    - which composer  # Debug: Wo ist composer?
  script:
    - composer test -- --testsuite=Unit --testdox --log-junit phpunit-report.xml --coverage-cobertura coverage-cobertura.xml --coverage-text --colors=never
  coverage: '/^\s*Lines:\s*\d+\.\d+\%/'
  artifacts:
    when: always
    reports:
      junit: backend/phpunit-report.xml
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage-cobertura.xml
    paths:
      - backend/phpunit-report.xml
      - backend/coverage-cobertura.xml
    expire_in: 1 week

# Job: Run Integration Tests
test_integration:
  stage: test
  dependencies:
    - install_dependencies
  services:
    - mysql:8.0
  variables:
    MYSQL_ROOT_PASSWORD: "root"
    MYSQL_DATABASE: "anmeldung_test"
    MYSQL_USER: "test"
    MYSQL_PASSWORD: "test"
    DB_HOST: "mysql"
  before_script:
    - cd backend

    # Wait for MySQL to be ready
    - apt-get update -qq && apt-get install -y -qq git unzip default-mysql-client libpng-dev libjpeg-dev libfreetype6-dev
    - until mysql -h mysql -u test -ptest --skip-ssl -e "SELECT 1"; do sleep 1; done

    # Install Composer and extensions
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - docker-php-ext-configure gd --with-freetype --with-jpeg
    - docker-php-ext-install pdo pdo_mysql gd

    # Import database schema
    - mysql -h mysql -u test -ptest --skip-ssl anmeldung_test < ../database/schema.sql
  script:
    - composer test -- --testsuite=Integration --testdox --log-junit phpunit-report.xml --no-coverage
  artifacts:
    when: always
    reports:
      junit: backend/phpunit-report.xml
    paths:
      - backend/phpunit-report.xml
    expire_in: 1 week
  # Integration tests are optional (allow failure for now)
  allow_failure: true

# Job: Code Coverage
coverage:
  stage: coverage
  dependencies:
    - install_dependencies
  before_script:
    - cd backend

    # Install dependencies (including libraries for GD)
    - apt-get update -qq
    - apt-get install -y -qq git unzip libpng-dev libjpeg-dev libfreetype6-dev

    # Install PHP extensions (including Xdebug for coverage)
    - pecl install xdebug
    - docker-php-ext-enable xdebug
    - docker-php-ext-configure gd --with-freetype --with-jpeg
    - docker-php-ext-install pdo pdo_mysql gd

    # Install Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  script:
    - export XDEBUG_MODE=coverage
    - composer test:coverage
    - echo "Coverage report generated at backend/coverage/index.html"
  coverage: '/^\s*Lines:\s*\d+\.\d+\%/'
  artifacts:
    paths:
      - backend/coverage/
    expire_in: 30 days
  # Coverage is optional (only run on main branch)
  only:
    - main
    - master
    - develop

# Job: Lint PHP Files
lint_php:
  stage: test
  dependencies: []
  before_script: []  # Override global before_script to stay in project root
  script:
    - find backend/src -name "*.php" -print0 | xargs -0 -n1 php -l
    - find backend/public -name "*.php" -print0 | xargs -0 -n1 php -l
    - find frontend/src -name "*.php" -print0 | xargs -0 -n1 php -l
    - find frontend/public -name "*.php" -print0 | xargs -0 -n1 php -l
    - echo "All PHP files are syntactically valid"

# Job: Secret Detection (GitLab Security Scanning)
#secret_detection:
#  stage: security
#  variables:
#    SECRET_DETECTION_ENABLED: 'true'
#  # Use GitLab's Secret Detection template
#  include:
#    - template: Security/Secret-Detection.gitlab-ci.yml

# Job: SAST (Static Application Security Testing)
#sast:
#  stage: security
#  # Use GitLab's SAST template
#  include:
#    - template: Security/SAST.gitlab-ci.yml

# Optional: Check Code Style (requires PHP_CodeSniffer)
# Uncomment to enable code style checks
# code_style:
#   stage: test
#   dependencies:
#     - install_dependencies
#   script:
#     - composer require --dev "squizlabs/php_codesniffer=*"
#     - ./vendor/bin/phpcs --standard=PSR12 backend/src
#   allow_failure: true

# Optional: Security Check (requires security-checker)
# Uncomment to enable security vulnerability scanning
# security_check:
#   stage: security
#   dependencies:
#     - install_dependencies
#   script:
#     - curl -H "Accept: text/plain" https://security.symfony.com/check_lock -F lock=@backend/composer.lock
#   allow_failure: true
##############
## ============================================================================
## Build Stage
## ============================================================================
#build:backend:
#  stage: build
#  image: composer:2
#  cache:
#    key: composer-$CI_COMMIT_REF_SLUG
#    paths:
#      - backend/vendor/
#  script:
#    - cd backend
#    - composer install --no-dev --optimize-autoloader
#    - composer dump-autoload --optimize
#  artifacts:
#    paths:
#      - backend/vendor/
#    expire_in: 1 hour
#  only:
#    - main
#    - develop
#    - /^release-.*$/
#
#build:docker:
#  stage: build
#  image: docker:24
#  services:
#    - docker:24-dind
#  variables:
#    DOCKER_DRIVER: overlay2
#    DOCKER_TLS_CERTDIR: "/certs"
#  before_script:
#    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
#  script:
#    - cd backend
#    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA .
#    - docker build -t $CI_REGISTRY_IMAGE/backend:latest .
#    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
#    - docker push $CI_REGISTRY_IMAGE/backend:latest
#  only:
#    - main
#    - develop
#
## ============================================================================
## Deploy Staging
## ============================================================================
#deploy:staging:
#  stage: deploy-staging
#  image: alpine:latest
#  before_script:
#    - apk add --no-cache openssh-client rsync
#    - eval $(ssh-agent -s)
#    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#    - mkdir -p ~/.ssh
#    - chmod 700 ~/.ssh
#    - ssh-keyscan -H $STAGING_SERVER >> ~/.ssh/known_hosts
#  script:
#    - echo "Deploying to staging server..."
#
#    # Rsync backend code
#    - rsync -avz --delete --exclude='.git' --exclude='vendor' --exclude='uploads' --exclude='cache'
#        backend/ $STAGING_USER@$STAGING_SERVER:$STAGING_PATH/backend/
#
#    # SSH into staging and update
#    - ssh $STAGING_USER@$STAGING_SERVER << 'EOF'
#        cd $STAGING_PATH/backend
#
#        # Pull latest images
#        docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull
#
#        # Restart containers
#        docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps backend
#
#        # Health check
#        sleep 10
#        curl -f http://localhost:8080/index.php || exit 1
#
#        echo "Staging deployment successful!"
#      EOF
#  environment:
#    name: staging
#    url: https://staging.intranet.example.com
#  only:
#    - develop
#  when: manual
#
## ============================================================================
## Deploy Production
## ============================================================================
#deploy:production:
#  stage: deploy-production
#  image: alpine:latest
#  before_script:
#    - apk add --no-cache openssh-client rsync
#    - eval $(ssh-agent -s)
#    - echo "$SSH_PRIVATE_KEY_PROD" | tr -d '\r' | ssh-add -
#    - mkdir -p ~/.ssh
#    - chmod 700 ~/.ssh
#    - ssh-keyscan -H $PRODUCTION_SERVER >> ~/.ssh/known_hosts
#  script:
#    - echo "Deploying to production server..."
#
#    # Backup first
#    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER << 'EOF'
#        /usr/local/bin/ondisos-backup.sh
#      EOF
#
#    # Rsync backend code
#    - rsync -avz --delete --exclude='.git' --exclude='vendor' --exclude='uploads' --exclude='cache'
#        backend/ $PRODUCTION_USER@$PRODUCTION_SERVER:$PRODUCTION_PATH/backend/
#
#    # SSH into production and update
#    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER << 'EOF'
#        cd $PRODUCTION_PATH/backend
#
#        # Pull latest images
#        docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull
#
#        # Rolling update (zero-downtime)
#        docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps backend
#
#        # Health check
#        sleep 15
#        curl -f http://localhost:8080/index.php || exit 1
#
#        # Cleanup old images
#        docker image prune -f
#
#        echo "Production deployment successful!"
#      EOF
#  environment:
#    name: production
#    url: https://intranet.example.com
#  only:
#    - main
#  when: manual
#
## ============================================================================
## Rollback Production
## ============================================================================
#rollback:production:
#  stage: deploy-production
#  image: alpine:latest
#  before_script:
#    - apk add --no-cache openssh-client
#    - eval $(ssh-agent -s)
#    - echo "$SSH_PRIVATE_KEY_PROD" | tr -d '\r' | ssh-add -
#    - mkdir -p ~/.ssh
#    - chmod 700 ~/.ssh
#    - ssh-keyscan -H $PRODUCTION_SERVER >> ~/.ssh/known_hosts
#  script:
#    - echo "Rolling back production to previous version..."
#    - ssh $PRODUCTION_USER@$PRODUCTION_SERVER << 'EOF'
#        cd $PRODUCTION_PATH/backend
#
#        # Rollback to previous git commit
#        git log --oneline -5
#        echo "Enter commit hash to rollback to (or press Ctrl+C to abort):"
#        read COMMIT_HASH
#        git checkout $COMMIT_HASH
#
#        # Rebuild and restart
#        docker-compose -f docker-compose.yml -f docker-compose.prod.yml build backend
#        docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps backend
#
#        # Health check
#        sleep 10
#        curl -f http://localhost:8080/index.php || exit 1
#
#        echo "Rollback successful!"
#      EOF
#  environment:
#    name: production
#  only:
#    - main
#  when: manual
